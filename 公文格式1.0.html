<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬æ–‡æ ¼å¼ç”Ÿæˆå™¨ & å¯¼å‡ºå·¥å…· (å›½æ ‡åˆè§„ç‰ˆ)</title>
    <!-- å¼•å…¥ TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ html2pdf.js ç”¨äºå¯¼å‡º PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒæ’ç‰ˆæ ·å¼ (CSS Variables) --- */
        :root {
            /* å­—ä½“å®šä¹‰ - ä¼˜å…ˆä½¿ç”¨æœ¬åœ°æ ‡å‡†å…¬æ–‡åˆ—å­—ä½“ (GBKç‰ˆ) */
            /* æµè§ˆå™¨é¢„è§ˆç”¨å­—ä½“æ ˆ */
            --font-title: "FangZheng XiaoBiaoSong_GBK", "æ–¹æ­£å°æ ‡å®‹_GBK", "æ–¹æ­£å°æ ‡å®‹ç®€ä½“", "SimSun", serif;
            --font-h1: "FangZheng HeiTi_GBK", "æ–¹æ­£é»‘ä½“_GBK", "SimHei", "é»‘ä½“", sans-serif;
            --font-h2: "FangZheng KaiTi_GBK", "æ–¹æ­£æ¥·ä½“_GBK", "KaiTi", "æ¥·ä½“", serif;
            --font-body: "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK", "FangSong", "ä»¿å®‹", serif;
            --font-num: "Times New Roman", serif;
            
            /* å›½æ ‡å­—å· */
            --font-size-2: 22pt;   /* äºŒå· - æ ‡é¢˜ */
            --font-size-3: 16pt;   /* ä¸‰å· - æ­£æ–‡/ä¸€çº§/äºŒçº§/é™„ä»¶ */
            --font-size-4: 14pt;   /* å››å· - ç‰ˆè®°/é¡µç  */
            
            /* è¡Œè·ä¸é—´è· */
            --line-height-fixed: 29pt; /* æ ‡å‡†è¡Œè·çº¦ 28-30pt */
        }

        /* æ¨¡æ‹Ÿ A4 çº¸å¼  - GB/T 9704-2012 æ ‡å‡†é¡µè¾¹è· */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin: 0 auto;
            /* ä¸Š37mm ä¸‹35mm å·¦28mm å³26mm */
            padding: 37mm 26mm 35mm 28mm; 
            position: relative;
            color: black;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- æ ·å¼ç±»å®šä¹‰ (å®Œå…¨å¯¹åº”å…¬æ–‡æ ‡å‡†) --- */

        /* 0. ç‰ˆå¤´çº¢çº¿ */
        .gw-red-line {
            width: 100%;
            height: 3px; 
            border-top: 1px solid #ff0000; 
            border-bottom: 2px solid #ff0000;
            margin-bottom: var(--line-height-fixed);
            display: none; 
        }
        .gw-red-line.active { display: block; }

        /* 1. å…¬æ–‡æ ‡é¢˜ï¼šæ–¹æ­£å°æ ‡å®‹2å·ï¼Œå±…ä¸­ */
        .gw-title {
            font-family: var(--font-title);
            font-size: var(--font-size-2);
            line-height: var(--line-height-fixed);
            text-align: center;
            margin-top: 0;
            margin-bottom: var(--line-height-fixed); 
            font-weight: normal;
        }

        /* 2. ä¸€çº§æ ‡é¢˜ï¼šé»‘ä½“3å· */
        .gw-h1 {
            font-family: var(--font-h1);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            font-weight: normal;
            margin: 0;
            text-indent: 2em; 
        }

        /* 3. äºŒçº§æ ‡é¢˜ï¼šæ¥·ä½“3å· */
        .gw-h2 {
            font-family: var(--font-h2);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            font-weight: normal;
            margin: 0;
            text-indent: 2em;
        }

        /* 4. æ­£æ–‡ï¼šä»¿å®‹3å· */
        .gw-body {
            font-family: var(--font-body);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            margin: 0;
            text-align: justify;
            text-indent: 2em;
        }

        /* 5. é™„ä»¶ */
        .gw-attachment-first {
            font-family: var(--font-body);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            margin: 0;
            text-align: justify;
            margin-left: 5em; 
            text-indent: -3em; /* æ‚¬æŒ‚ç¼©è¿› */
        }

        .gw-attachment-following {
            font-family: var(--font-body);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            margin: 0;
            text-align: justify;
            margin-left: 5em; 
            text-indent: 0;
        }

        /* 6. è½æ¬¾å®¹å™¨ */
        .gw-sig-box {
            font-family: var(--font-body);
            font-size: var(--font-size-3);
            line-height: var(--line-height-fixed);
            margin-top: calc(var(--line-height-fixed) * 2); 
            display: table; 
            margin-left: auto; 
            margin-right: 4em; 
            text-align: center;
        }

        .gw-sig-item {
            display: block;
            white-space: nowrap;
        }

        /* 7. ç‰ˆè®° - æ²‰åº• */
        .gw-banji-container {
            margin-top: auto; 
            width: 100%;
            border-top: 1px solid #000; 
            padding-top: 5px;
            font-family: var(--font-body);
            font-size: var(--font-size-4); 
            line-height: 1.5;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .gw-banji-row {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            margin-bottom: 5px;
        }
        
        .gw-banji-content {
            flex: 1;
            text-align: left;
        }
        
        /* 8. é¢„è§ˆé¡µç  (ä»…è§†è§‰æ¨¡æ‹Ÿ) */
        .gw-preview-pagenum {
            position: absolute;
            bottom: 25mm; /* å›½æ ‡è¦æ±‚åº•è¾¹è·35mmï¼Œé¡µç åœ¨ç‰ˆå¿ƒä¸‹è¾¹ç¼˜ä¹‹ä¸‹ï¼Œçº¦25-28mmå¤„ */
            width: 100%;
            text-align: center;
            left: 0;
            font-family: var(--font-num); /* é¢„è§ˆæ—¶ä½¿ç”¨ Times */
            font-size: var(--font-size-4);
            pointer-events: none;
        }

        /* è¾…åŠ©ç©ºè¡Œ */
        .gw-empty-line {
            height: var(--line-height-fixed);
        }

        #editor {
            white-space: pre-wrap; 
        }

        .check-panel.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-sm">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-6 shadow-sm z-20">
        <div class="flex items-center gap-2">
            <div class="w-7 h-7 bg-red-700 rounded flex items-center justify-center text-white font-serif font-bold text-lg">å›½</div>
            <h1 class="text-lg font-bold text-gray-800 tracking-wide">å…¬æ–‡æ ¼å¼ç”Ÿæˆå™¨ <span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded ml-1 align-top border border-red-200">GB/T 9704â€”2012</span></h1>
        </div>
        
        <div class="flex gap-2">
            <button onclick="runComplianceCheck()" class="flex items-center gap-1.5 px-3 py-1.5 bg-yellow-50 text-yellow-700 rounded hover:bg-yellow-100 transition border border-yellow-200 font-medium text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                åˆè§„æ€§æ£€æŸ¥
            </button>
            <button onclick="autoFormat(true)" class="flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition border border-blue-200 font-medium text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                æ™ºèƒ½æ’ç‰ˆ (å›½æ ‡)
            </button>
            <button onclick="exportToWord()" class="flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white rounded hover:bg-red-700 transition shadow-sm font-medium text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                å¯¼å‡º Word
            </button>
            <button onclick="exportToPDF()" class="flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white rounded hover:bg-purple-700 transition shadow-sm font-medium text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                å¯¼å‡º PDF
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§ç¼–è¾‘åŒº -->
        <section class="w-1/3 min-w-[420px] bg-white border-r border-gray-200 flex flex-col z-10 shadow-[4px_0_24px_rgba(0,0,0,0.05)] relative">
            <div class="p-2 border-b border-gray-100 bg-gray-50 flex flex-wrap gap-2 items-center justify-between">
                <div class="flex gap-2">
                    <button onclick="insertSample()" class="text-xs px-2 py-1 bg-white border rounded hover:text-blue-600 hover:border-blue-300">è½½å…¥èŒƒæ–‡</button>
                    <button onclick="clearContent()" class="text-xs px-2 py-1 bg-white border rounded text-red-500 hover:bg-red-50 hover:border-red-300">æ¸…ç©º</button>
                </div>
            </div>

            <!-- æ£€æŸ¥ç»“æœé€šçŸ¥é¢æ¿ -->
            <div id="checkPanel" class="hidden absolute top-[45px] left-2 right-2 bg-white border border-yellow-200 shadow-lg rounded-md z-20 p-3 text-xs animate-fade-in">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-gray-800 flex items-center gap-1">
                        <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        åˆè§„æ€§æ£€æŸ¥æŠ¥å‘Š
                    </h3>
                    <button onclick="document.getElementById('checkPanel').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">&times;</button>
                </div>
                <ul id="checkList" class="space-y-1 text-gray-600 list-disc list-inside"></ul>
            </div>
            
            <div class="px-4 py-2 bg-blue-50 text-blue-800 text-xs border-b border-blue-100 leading-5">
                <strong>ğŸ’¡ æ“ä½œæŒ‡å¼•ï¼š</strong><br>
                1. <strong>ç‰ˆå¤´</strong>ï¼šç¬¬ä¸€è¡Œé»˜è®¤ä¸ºå…¬æ–‡æ ‡é¢˜ï¼Œè‡ªåŠ¨å±…ä¸­ã€‚<br>
                2. <strong>ç‰ˆè®°</strong>ï¼šè‹¥è¾“å…¥â€œæŠ„é€ï¼š...â€ï¼Œè‡ªåŠ¨è¯†åˆ«ä¸ºç‰ˆè®°å¹¶æ²‰åº•ã€‚<br>
                3. <strong>çº¢çº¿</strong>ï¼šå¯¼å‡ºæ—¶è‡ªåŠ¨åŒ…å«æ–‡å¤´çº¢çº¿ã€‚<br>
            </div>

            <div id="editor" 
                 contenteditable="true" 
                 class="flex-1 p-6 overflow-y-auto outline-none text-gray-700 leading-relaxed font-mono text-sm border-b"
                 oninput="handleInput()">
å…³äºåšå¥½å…¬æ–‡æ ¼å¼æ’ç‰ˆå·¥ä½œçš„é€šçŸ¥
å„éƒ¨é—¨ã€å„å•ä½ï¼š
ä¸ºäº†è¿›ä¸€æ­¥è§„èŒƒå…¬æ–‡å¤„ç†å·¥ä½œï¼Œæé«˜å…¬æ–‡è´¨é‡ï¼Œæ ¹æ®ã€Šå…šæ”¿æœºå…³å…¬æ–‡æ ¼å¼ã€‹å›½å®¶æ ‡å‡†ï¼Œç°å°†æœ‰å…³äº‹é¡¹é€šçŸ¥å¦‚ä¸‹ï¼š
ä¸€ã€é¡µé¢è®¾ç½®è¦æ±‚
å…¬æ–‡ç”¨çº¸é‡‡ç”¨A4å‹çº¸ã€‚é¡µè¾¹è·è®¾ç½®ä¸ºä¸Š37mmï¼Œä¸‹35mmï¼Œå·¦28mmï¼Œå³26mmã€‚
äºŒã€æ­£æ–‡ä¸æ ‡é¢˜
æ­£æ–‡é¦–è¡Œç¼©è¿›2å­—ç¬¦ï¼Œä¸¤ç«¯å¯¹é½ã€‚å…¬æ–‡æ ‡é¢˜å±…ä¸­ï¼Œä¸‹ç©ºä¸€è¡Œã€‚ä¸€çº§æ ‡é¢˜é»‘ä½“ï¼ŒäºŒçº§æ ‡é¢˜æ¥·ä½“ã€‚
é™„ä»¶ï¼š1.å…¬æ–‡æ’ç‰ˆè§„èŒƒç»†åˆ™
2.æœºå…³å…¬æ–‡æ ¼å¼å‚è€ƒæ¨¡æ¿
ç‰¹æ­¤é€šçŸ¥ã€‚
åŠå…¬å®¤
2023å¹´10æœˆ24æ—¥
æŠ„é€ï¼šå„ç§‘å®¤ï¼Œå­˜æ¡£ã€‚
å°å‘æœºå…³ï¼šåŠå…¬å®¤  å°å‘æ—¥æœŸï¼š2023å¹´10æœˆ25æ—¥
            </div>

            <!-- åº•éƒ¨çŠ¶æ€æ  -->
            <footer class="h-8 bg-gray-50 border-t border-gray-200 flex items-center justify-between px-4 text-xs text-gray-500">
                <div id="charCount">å­—æ•°: 0</div>
                <div id="pageEstimate">é¢„è®¡é¡µæ•°: 1 é¡µ</div>
            </footer>
        </section>

        <!-- å³ä¾§é¢„è§ˆåŒº -->
        <section class="flex-1 bg-gray-200 overflow-y-auto p-8 flex justify-center relative">
            <div class="absolute top-4 right-8 bg-gray-800 text-white text-xs px-3 py-1.5 rounded shadow opacity-80 pointer-events-none z-10">
                å›½æ ‡ A4 é¢„è§ˆ
            </div>
            
            <!-- é¢„è§ˆé¡µ -->
            <div id="preview-page" class="a4-page">
                <!-- å†…å®¹ç”± JS ç”Ÿæˆ -->
            </div>
        </section>
    </main>

    <script>
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview-page');
        const charCountEl = document.getElementById('charCount');
        const pageEstimateEl = document.getElementById('pageEstimate');
        const checkPanel = document.getElementById('checkPanel');
        const checkList = document.getElementById('checkList');

        let timeoutId;

        // åˆå§‹åŒ–
        window.onload = function() {
            autoFormat(false); 
            updateStats();
        };

        function handleInput() {
            updateStats();
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => autoFormat(false), 800);
        }

        function updateStats() {
            const text = editor.innerText.replace(/\n/g, '');
            const count = text.length;
            charCountEl.innerText = `å­—æ•°: ${count}`;
            const estPages = Math.max(1, Math.ceil(count / 550));
            pageEstimateEl.innerText = `é¢„è®¡é¡µæ•°: ${estPages} é¡µ`;
        }

        function insertSample() {
            editor.innerText = `å…³äºè¿›ä¸€æ­¥è§„èŒƒæœºå…³å…¬æ–‡æ ¼å¼çš„é€šçŸ¥
å„éƒ¨é—¨ã€å„ä¸‹å±å•ä½ï¼š
ä¸ºæ¨è¿›å…¬æ–‡å¤„ç†å·¥ä½œç§‘å­¦åŒ–ã€åˆ¶åº¦åŒ–ã€è§„èŒƒåŒ–ï¼Œæ ¹æ®ã€Šå…šæ”¿æœºå…³å…¬æ–‡æ ¼å¼ã€‹ï¼ˆGB/T 9704â€”2012ï¼‰è¦æ±‚ï¼Œç°å°±æœ‰å…³äº‹é¡¹é€šçŸ¥å¦‚ä¸‹ï¼š
ä¸€ã€ç‰ˆé¢è¦æ±‚
å…¬æ–‡ç”¨çº¸é‡‡ç”¨A4å‹çº¸ã€‚é¡µè¾¹è·è®¾ç½®ä¸ºä¸Š37mmï¼Œä¸‹35mmï¼Œå·¦28mmï¼Œå³26mmã€‚è¡Œæ•°æ¯é¡µ22è¡Œï¼Œæ¯è¡Œ28å­—ã€‚
äºŒã€å­—ä½“è¦æ±‚
ï¼ˆä¸€ï¼‰æ ‡é¢˜å­—ä½“ã€‚å…¬æ–‡æ ‡é¢˜ä½¿ç”¨æ–¹æ­£å°æ ‡å®‹ä½“ï¼ŒäºŒå·å­—ã€‚
ï¼ˆäºŒï¼‰æ­£æ–‡å­—ä½“ã€‚æ­£æ–‡ä½¿ç”¨æ–¹æ­£ä»¿å®‹ä½“ï¼Œä¸‰å·å­—ã€‚ä¸€çº§æ ‡é¢˜ä½¿ç”¨é»‘ä½“ï¼ŒäºŒçº§æ ‡é¢˜ä½¿ç”¨æ¥·ä½“ã€‚
é™„ä»¶ï¼š1.å…¬æ–‡æ ¼å¼æ’ç‰ˆå‚æ•°è¡¨
2.å¸¸ç”¨å…¬æ–‡æ¨¡æ¿ï¼ˆæ³¨æ„æ­¤è¡Œå¯¹é½æ•ˆæœï¼‰
ç‰¹æ­¤é€šçŸ¥ã€‚
è¡Œæ”¿åŠå…¬å®¤
2023å¹´11æœˆ15æ—¥
æŠ„é€ï¼šå„åˆ†ç®¡é¢†å¯¼ï¼Œå­˜æ¡£ã€‚
å°å‘æœºå…³ï¼šè¡Œæ”¿åŠå…¬å®¤  å°å‘æ—¥æœŸï¼š2023å¹´11æœˆ15æ—¥`;
            autoFormat(true);
        }

        function clearContent() {
            editor.innerText = "";
            preview.innerHTML = "";
            updateStats();
            checkPanel.classList.add('hidden');
        }

        // --- åŠŸèƒ½ï¼šåˆè§„æ€§æ£€æŸ¥ ---
        function runComplianceCheck() {
            const text = editor.innerText;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const issues = [];

            if (lines.length === 0) {
                issues.push("æ–‡æ¡£å†…å®¹ä¸ºç©ºã€‚");
            } 
            
            const dateRegex = /(20\d{2}|äºŒã€‡[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åã€‡]+)å¹´[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æœˆ[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ—¥/;
            if (!lines.some(line => dateRegex.test(line))) {
                issues.push("æœªæ£€æµ‹åˆ°æ ‡å‡†çš„æˆæ–‡æ—¥æœŸï¼ˆå¦‚ï¼š2023å¹´11æœˆ15æ—¥ï¼‰ã€‚");
            }
            
            const halfWidthPunctuation = /[\u4e00-\u9fa5]+[,.?!:;][\u4e00-\u9fa5]+/;
            if (halfWidthPunctuation.test(text)) {
                issues.push("ä¸­æ–‡æ®µè½ä¸­å­˜åœ¨è‹±æ–‡æ ‡ç‚¹ï¼Œå»ºè®®ä½¿ç”¨â€œæ™ºèƒ½æ’ç‰ˆâ€çº æ­£ã€‚");
            }

            checkList.innerHTML = "";
            if (issues.length === 0) {
                checkList.innerHTML = `<li class="text-green-600 font-bold">âœ“ æ–‡æ¡£æ ¼å¼ç¬¦åˆ GB/T 9704 åŸºæœ¬è¦ç´ ã€‚</li>`;
            } else {
                issues.forEach(issue => {
                    checkList.innerHTML += `<li class="text-red-600">âš  ${issue}</li>`;
                });
            }
            checkPanel.classList.remove('hidden');
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæ™ºèƒ½æ ¼å¼åŒ– (å›½æ ‡ V2.2) ---
        function autoFormat(showToast = false) {
            let text = editor.innerText;
            if (!text.trim()) return;

            if (showToast) {
                text = text.replace(/,/g, 'ï¼Œ').replace(/\?/g, 'ï¼Ÿ').replace(/!/g, 'ï¼').replace(/;/g, 'ï¼›')
                           .replace(/([^0-9]):([^0-9])/g, '$1ï¼š$2') 
                           .replace(/([\u4e00-\u9fa5])\./g, '$1ã€‚');
            }

            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            let html = '';
            
            html += `<div class="gw-red-line active"></div>`;

            let dateLineIndex = -1;
            let sigLineIndex = -1;
            let banjiStartIndex = -1;
            const dateRegex = /^(20\d{2}|äºŒã€‡[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åã€‡]+)å¹´[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æœˆ[0-9ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+æ—¥/;

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith("æŠ„é€") || lines[i].startsWith("å°å‘")) {
                    banjiStartIndex = i;
                    break;
                }
            }

            let searchLimit = banjiStartIndex !== -1 ? banjiStartIndex : lines.length;
            for (let i = searchLimit - 1; i >= 0; i--) {
                if (dateRegex.test(lines[i])) {
                    dateLineIndex = i;
                    if (i > 0 && !lines[i-1].match(/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/) && lines[i-1].length < 20) {
                        sigLineIndex = i - 1;
                    }
                    break;
                }
            }

            let isAttachmentBlock = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                if (showToast) {
                     line = line.replace(/,/g, 'ï¼Œ').replace(/\?/g, 'ï¼Ÿ').replace(/!/g, 'ï¼').replace(/;/g, 'ï¼›')
                                .replace(/([\u4e00-\u9fa5]):/g, '$1ï¼š')
                                .replace(/([\u4e00-\u9fa5])\./g, '$1ã€‚');
                }

                if (i === banjiStartIndex) {
                    html += `<div class="gw-banji-container">`;
                    for (let j = i; j < lines.length; j++) {
                        let bLine = lines[j];
                        html += `<div class="gw-banji-row"><div class="gw-banji-content">${bLine}</div></div>`;
                    }
                    html += `</div>`;
                    break; 
                }

                if (i === sigLineIndex && dateLineIndex !== -1) {
                    const sigText = lines[sigLineIndex];
                    const dateText = lines[dateLineIndex];
                    const cleanDate = dateText.match(dateRegex) ? dateText.match(dateRegex)[0] : dateText;

                    html += `
                    <div class="gw-sig-box">
                        <div class="gw-sig-item">${sigText}</div>
                        <div class="gw-sig-item">${cleanDate}</div>
                    </div>`;
                    i++; 
                    continue;
                }
                
                if (i === dateLineIndex && sigLineIndex === -1) {
                     const cleanDate = line.match(dateRegex) ? line.match(dateRegex)[0] : line;
                     html += `
                    <div class="gw-sig-box">
                        <div class="gw-sig-item">${cleanDate}</div>
                    </div>`;
                    continue;
                }

                if (i === 0) {
                    html += `<div class="gw-title">${line}</div>`;
                    continue;
                }

                if (line.startsWith("é™„ä»¶ï¼š") || line.startsWith("é™„ä»¶:")) {
                    html += `<div class="gw-empty-line"></div>`; 
                    line = line.replace("é™„ä»¶:", "é™„ä»¶ï¼š");
                    html += `<div class="gw-attachment-first">${line}</div>`;
                    isAttachmentBlock = true;
                    continue;
                }
                if (isAttachmentBlock && i < searchLimit) {
                     html += `<div class="gw-attachment-following">${line}</div>`;
                     continue;
                } else {
                    isAttachmentBlock = false;
                }

                if (/^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€/.test(line)) {
                    html += `<div class="gw-h1">${line}</div>`;
                    continue;
                }

                if (/^ï¼ˆ[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ï¼‰/.test(line)) {
                    html += `<div class="gw-h2">${line}</div>`;
                    continue;
                }

                html += `<div class="gw-body">${line}</div>`;
            }
            
            html += `<div class="gw-preview-pagenum">â€” 1 â€”</div>`;

            preview.innerHTML = html;
            if (showToast) checkPanel.classList.add('hidden');
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šå¯¼å‡º Word (å®Œç¾ä¿®å¤ç‰ˆ) ---
        function exportToWord() {
            const contentHtml = preview.innerHTML;
            const titleDiv = preview.querySelector('.gw-title');
            // å›å½’åˆ° .doc æ ¼å¼ï¼Œå› ä¸ºæˆ‘ä»¬ç”Ÿæˆçš„æ˜¯ MHTML/HTML ä¼ªè£…æ ¼å¼
            // å­˜ä¸º .docx ä¼šå¯¼è‡´ Word æ— æ³•è§£å‹è€ŒæŠ¥é”™
            let fileName = 'æ ‡å‡†å…¬æ–‡.doc';

            if (titleDiv && titleDiv.innerText.trim()) {
                let rawTitle = titleDiv.innerText.trim();
                fileName = rawTitle.replace(/[\n\r]/g, '').replace(/[\\/:*?"<>|]/g, '_').substring(0, 50) + '.doc';
            }

            const preHtml = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                      xmlns:w='urn:schemas-microsoft-com:office:word' 
                      xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>å…¬æ–‡å¯¼å‡º</title>
                    <style>
                        /* Word é¡µé¢è®¾ç½® - å›½æ ‡: ä¸Š37 ä¸‹35 å·¦28 å³26 */
                        @page Section1 {
                            size: 210mm 297mm;
                            margin: 37mm 26mm 35mm 28mm;
                            mso-header-margin: 15mm;
                            mso-footer-margin: 28mm;
                            mso-title-page: yes; 
                            layout-grid: 15.6pt; 
                            mso-footer: f1; 
                        }
                        div.Section1 { page: Section1; }
                        
                        /* å…¨å±€æ ·å¼ - å¼ºåˆ¶ä¸­è¥¿æ–‡åˆ†å¼€ */
                        body { 
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16pt; 
                        }
                        
                        /* æ ‡é¢˜ï¼šæ–¹æ­£å°æ ‡å®‹_GBK */
                        .gw-title {
                            font-family: "Times New Roman", "FangZheng XiaoBiaoSong_GBK", "æ–¹æ­£å°æ ‡å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£å°æ ‡å®‹_GBK";
                            font-size: 22.0pt;
                            text-align: center;
                            line-height: 29.0pt;
                            margin-bottom: 29.0pt; 
                            mso-line-height-rule: exactly;
                            font-weight: normal;
                        }

                        /* ä¸€çº§æ ‡é¢˜ï¼šæ–¹æ­£é»‘ä½“_GBK */
                        .gw-h1 {
                            font-family: "Times New Roman", "FangZheng HeiTi_GBK", "æ–¹æ­£é»‘ä½“_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£é»‘ä½“_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            margin: 0;
                            text-indent: 32.0pt;
                            mso-char-indent-count: 2.0;
                            mso-line-height-rule: exactly;
                            font-weight: normal;
                        }

                        /* äºŒçº§æ ‡é¢˜ï¼šæ–¹æ­£æ¥·ä½“_GBK */
                        .gw-h2 {
                            font-family: "Times New Roman", "FangZheng KaiTi_GBK", "æ–¹æ­£æ¥·ä½“_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£æ¥·ä½“_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            margin: 0;
                            text-indent: 32.0pt;
                            mso-char-indent-count: 2.0;
                            mso-line-height-rule: exactly;
                            font-weight: normal;
                        }

                        /* æ­£æ–‡ï¼šæ–¹æ­£ä»¿å®‹_GBK */
                        .gw-body {
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            margin: 0;
                            text-align: justify;
                            text-justify: inter-ideograph;
                            text-indent: 32.0pt;
                            mso-char-indent-count: 2.0;
                            mso-line-height-rule: exactly;
                        }

                        /* é™„ä»¶ - é¦–è¡Œ */
                        .gw-attachment-first {
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            text-align: justify;
                            margin: 0;
                            margin-left: 80.0pt; 
                            text-indent: -48.0pt; 
                            mso-line-height-rule: exactly;
                        }
                        /* é™„ä»¶ - åç»­ */
                        .gw-attachment-following {
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            text-align: justify;
                            margin: 0;
                            margin-left: 80.0pt; 
                            text-indent: 0;
                            mso-line-height-rule: exactly;
                        }
                        
                        .gw-empty-line { font-size: 16.0pt; line-height: 29.0pt; }

                        /* è½æ¬¾ */
                        .gw-sig-box {
                            margin-top: 58.0pt; 
                            text-align: right; 
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                        }
                        
                        table.sig-table {
                            mso-table-layout-alt: fixed;
                            float: right;
                            margin-right: 64.0pt; 
                            border: none;
                        }
                        td.sig-cell {
                            text-align: center;
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 16.0pt;
                            line-height: 29.0pt;
                            border: none;
                        }
                        
                        /* ç‰ˆè®° */
                        .gw-banji-container {
                            margin-top: 50.0pt; 
                            border-top: 1px solid #000;
                            padding-top: 10.0pt;
                            font-family: "Times New Roman", "FangZheng FangSong_GBK", "æ–¹æ­£ä»¿å®‹_GBK";
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "æ–¹æ­£ä»¿å®‹_GBK";
                            font-size: 14.0pt;
                            line-height: 1.5;
                        }
                        .gw-banji-row { margin-bottom: 5pt; }

                        /* çº¢çº¿ */
                        .gw-red-line {
                            border-top: 1px solid red;
                            border-bottom: 2px solid red;
                            height: 4px;
                            margin-bottom: 28pt;
                        }

                        /* é¡µç  */
                        p.MsoFooter {
                            font-family: "Times New Roman", "SimSun", serif;
                            mso-ascii-font-family: "Times New Roman";
                            mso-hansi-font-family: "Times New Roman";
                            mso-fareast-font-family: "SimSun";
                            font-size: 14.0pt;
                            text-align: center;
                            line-height: 14.0pt;
                            mso-pagination: widow-orphan;
                        }
                    </style>
                    <xml>
                        <w:WordDocument>
                            <w:View>Print</w:View>
                            <w:DoNotOptimizeForBrowser/>
                        </w:WordDocument>
                    </xml>
                </head>
                <body>
                    <div class="Section1">
            `;

            const div = document.createElement('div');
            div.innerHTML = contentHtml;
            
            const previewPageNum = div.querySelector('.gw-preview-pagenum');
            if (previewPageNum) previewPageNum.remove();
            
            const sigBox = div.querySelector('.gw-sig-box');
            if (sigBox) {
                const items = sigBox.querySelectorAll('.gw-sig-item');
                let rows = '';
                items.forEach(item => {
                    rows += `<tr><td class="sig-cell">${item.innerText}</td></tr>`;
                });
                sigBox.outerHTML = `<div style="margin-top: 58pt; overflow: hidden;"><table class="sig-table" border="0" cellspacing="0" cellpadding="0">${rows}</table></div>`;
            }

            const cleanContent = div.innerHTML;

            const postHtml = `
                    </div>
                    <!-- é€šç”¨é¡µè„š (å±…ä¸­) -->
                    <div style='mso-element:footer' id="f1">
                        <p class=MsoFooter align=center style='text-align:center'>
                           <span style="font-family:'Times New Roman'; mso-bidi-font-family:'Times New Roman'">â€”</span>
                           <span style='mso-field-code:" PAGE "'></span>
                           <span style="font-family:'Times New Roman'; mso-bidi-font-family:'Times New Roman'">â€”</span>
                        </p>
                    </div>
                </body>
                </html>
            `;

            const fullHtml = preHtml + cleanContent + postHtml;
            const blob = new Blob(['\ufeff', fullHtml], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- æ–°å¢ï¼šå¯¼å‡º PDF (è‡ªåŠ¨å‘½å) ---
        function exportToPDF() {
            const element = document.getElementById('preview-page');
            const titleDiv = element.querySelector('.gw-title');
            let fileName = 'æ ‡å‡†å…¬æ–‡.pdf';

            if (titleDiv && titleDiv.innerText.trim()) {
                let rawTitle = titleDiv.innerText.trim();
                fileName = rawTitle.replace(/[\n\r]/g, '').replace(/[\\/:*?"<>|]/g, '_').substring(0, 50) + '.pdf';
            }

            // html2pdf é…ç½®
            const opt = {
                margin:       0, // ä½¿ç”¨ 0 è¾¹è·ï¼Œå› ä¸ºå†…å®¹æœ¬èº«å·²æœ‰ padding
                filename:     fileName,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 }, // æé«˜æ¸…æ™°åº¦
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
